<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Spring ì‹¤ì‹œê°„ ì±„íŒ…</title>

    <!-- SockJS / STOMP CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 40px; background: #f9f9f9; }
        #chatBox { width: 400px; height: 400px; border: 1px solid #ccc; overflow-y: auto; padding: 10px; background: white; }
        #chatInput { margin-top: 10px; display: flex; }
        #chatInput input { flex: 1; padding: 8px; border: 1px solid #aaa; border-radius: 5px; }
        #chatInput button { padding: 8px 15px; margin-left: 5px; border: none; background: #4CAF50; color: white; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<h2>ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ…</h2>
<div>
    <label>ë‹‰ë„¤ì„:</label>
    <input type="text" id="sender" placeholder="ì´ë¦„ ì…ë ¥" />
    <label>ë°© ID:</label>
    <input type="text" id="roomId" value="1" />
    <button onclick="connect()">ì±„íŒ… ì‹œì‘</button>
</div>

<div id="chatBox"></div>

<div id="chatInput">
    <input type="text" id="message" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeydown="if(event.key==='Enter') sendMessage()" />
    <button onclick="sendMessage()">ì „ì†¡</button>
</div>

<script>
    let stompClient = null;
    let roomId = null;
    let sender = null;

    function connect() {
      roomId = document.getElementById("roomId").value;
      sender = document.getElementById("sender").value;

      if (!sender) {
        alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!");
        return;
      }

      const socket = new SockJS("/ws/chat");
      stompClient = Stomp.over(socket);

      stompClient.connect({}, function () {
        console.log("âœ… Connected to WebSocket");

        // êµ¬ë… ì„¤ì •
        stompClient.subscribe("/sub/chat/room/" + roomId, function (msg) {
          const message = JSON.parse(msg.body);
          showMessage(message.sender + ": " + message.message);
        });

        // ì…ì¥ ì•Œë¦¼
        stompClient.send("/pub/chat/message", {}, JSON.stringify({
          roomId: roomId,
          sender: sender,
          message: sender + "ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤."
        }));
      });
    }

    function sendMessage() {
      const msgInput = document.getElementById("message");
      const msg = msgInput.value.trim();

      if (msg && stompClient) {
        stompClient.send("/pub/chat/message", {}, JSON.stringify({
          roomId: roomId,
          sender: sender,
          message: msg
        }));
        msgInput.value = "";
      }
    }

    function showMessage(message) {
      const chatBox = document.getElementById("chatBox");
      const p = document.createElement("p");
      p.textContent = message;
      chatBox.appendChild(p);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
</body>
</html>
