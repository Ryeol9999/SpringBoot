<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Spring ì‹¤ì‹œê°„ ì±„íŒ…</title>

    <!-- SockJS & STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        body {
          font-family: "Segoe UI", sans-serif;
          background: #f5f6fa;
          margin: 40px;
        }

        h2 {
          color: #333;
          margin-bottom: 15px;
        }

        .chat-container {
          max-width: 450px;
          margin-top: 10px;
        }

        .input-group {
          display: flex;
          gap: 10px;
          margin-bottom: 10px;
          align-items: center;
        }

        .input-group input {
          flex: 1;
          padding: 8px;
          border: 1px solid #bbb;
          border-radius: 5px;
          font-size: 14px;
        }

        .input-group button {
          background: #4caf50;
          color: white;
          border: none;
          padding: 8px 15px;
          border-radius: 5px;
          cursor: pointer;
          font-weight: 600;
        }

        .input-group button:hover {
          background: #43a047;
        }

        #chatBox {
          width: 100%;
          height: 400px;
          background: white;
          border: 1px solid #ccc;
          border-radius: 8px;
          padding: 10px;
          overflow-y: auto;
        }

        #chatInput {
          display: flex;
          margin-top: 10px;
          gap: 5px;
        }

        #chatInput input {
          flex: 1;
          padding: 8px;
          border: 1px solid #aaa;
          border-radius: 5px;
        }

        #chatInput button {
          background: #2196f3;
          color: white;
          border: none;
          border-radius: 5px;
          padding: 8px 15px;
          cursor: pointer;
          font-weight: 600;
        }

        #chatInput button:hover {
          background: #1976d2;
        }

        p {
          margin: 5px 0;
        }

        .system-message {
          color: #888;
          font-style: italic;
        }

        .user-message {
          color: #333;
        }
    </style>
</head>
<body>
<h2>ðŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ…</h2>

<div class="chat-container">
    <div class="input-group">
        <label>ë‹‰ë„¤ìž„:</label>
        <input type="text" id="sender" placeholder="ì´ë¦„ ìž…ë ¥" />
        <label>ë°© ID:</label>
        <input type="text" id="roomId" value="1" />
        <button onclick="connect()">ì±„íŒ… ì‹œìž‘</button>
    </div>

    <div id="chatBox"></div>

    <div id="chatInput">
        <input
                type="text"
                id="message"
                placeholder="ë©”ì‹œì§€ë¥¼ ìž…ë ¥í•˜ì„¸ìš”..."
                onkeydown="if(event.key==='Enter') sendMessage()"
        />
        <button onclick="sendMessage()">ì „ì†¡</button>
    </div>
</div>

<script>
    let stompClient = null;
    let roomId = null;
    let sender = null;

    function connect() {
      roomId = document.getElementById("roomId").value.trim();
      sender = document.getElementById("sender").value.trim();

      if (!sender) {
        alert("ë‹‰ë„¤ìž„ì„ ìž…ë ¥í•˜ì„¸ìš”!");
        return;
      }

      const socket = new SockJS("/ws/chat");
      stompClient = Stomp.over(socket);

      stompClient.connect({}, () => {
        console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ");
        subscribeToRoom();
        sendSystemMessage(`${sender}ë‹˜ì´ ìž…ìž¥í–ˆìŠµë‹ˆë‹¤.`);
      });
    }

    function subscribeToRoom() {
      stompClient.subscribe(`/sub/chat/room/${roomId}`, (msg) => {
        const { sender, message } = JSON.parse(msg.body);
        const isSystem = message.includes("ìž…ìž¥í–ˆìŠµë‹ˆë‹¤.") || message.includes("í‡´ìž¥í–ˆìŠµë‹ˆë‹¤.");
        showMessage(sender, message, isSystem);
      });
    }

    function sendMessage() {
      const input = document.getElementById("message");
      const message = input.value.trim();

      if (message && stompClient) {
        stompClient.send(
          "/pub/chat/message",
          {},
          JSON.stringify({ roomId, sender, message })
        );
        input.value = "";
      }
    }

    function sendSystemMessage(message) {
      stompClient.send(
        "/pub/chat/message",
        {},
        JSON.stringify({ roomId, sender: "System", message })
      );
    }

    function showMessage(senderName, message, isSystem = false) {
      const chatBox = document.getElementById("chatBox");
      const p = document.createElement("p");
      p.className = isSystem ? "system-message" : "user-message";
      p.textContent = isSystem ? message : `${senderName}: ${message}`;
      chatBox.appendChild(p);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
</body>
</html>
